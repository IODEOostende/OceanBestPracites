# Virtuoso Triple Store

The Virtuoso Triple Store instance is running on an EC2 instance and can be launched by a Cloud Formation template.


### Overview

- Creating a Virtuoso Stack
    - Docker Image
- Importing OWL Ontology
    - Importing a Large OWL Ontology (Bulk Loading)
- Importing SKOS Vocabulary

## Creating a Virtuoso Stack

You can launch new instances of Virtuoso for recovery or testing purposes by launching a new cloudformation stack:

```
aws cloudformation deploy --template-file virtuoso-instance.yml --stack-name {NAME} --parameter-overrides VpcId={VPCID} Environment={ENVIRONMENT} KeyPairName={KEY_PAIR} InstanceType={EC2_INSTANCE_TYPE} --profile {AWS_PROFILE}
```

The InstanceType parameter will default to a t2.small (you can view this in the CloudFormation template). Please note that t2.small is pretty small and you will most
likely want to bump that up. For cost reasons the template defaults to this size. The virtuoso.ini settings in the CloudFormation template allocates buffers per the recommended values
based on ~2GB of free memory (the available memory for a t2.small). If you launch with a smaller instance size you should adjust those numbers. You can adjust those values larger
if you want more memory and use a larger instance.

This stack creates an EC2 instance and spins up an instance of Virtuoso within a Docker Container. It also creates a Security Group which will allow HTTP access to port 8890 (Virtuoso default) and SSH access.

The template provides a base virtuoso.ini file and can be configured within the template if any of the default parameters should be changed.

### Docker Image

The Docker image used for our instance of Virtuoso can be found here:

[https://hub.docker.com/r/openlink/virtuoso-opensource-7/]

The docker image used specifies the latest version of Virtuoso 7.x. You should review the docker page for specific instructions. Unless otherwise stated in this document the default values are used. Please note that the default user name and password is automatically generated by Virtuoso at the time of install. Per the documentation on the Docker page:

> If the DBA_PASSWORD Environment variable is not set, a random password will be assigned to the dba user account, and stored on the internal docker filesystem as /settings/dba_password.

The next section describes how to access the docker filesystem so that you can access that password.

## SSH Access and Accessing the Virtuoso Instance

You can SSH to the Virtuoso instance using the key pair that was set during the Virtuoso Cloudformation Stack creation. For example:

```
> ssh -i iode-admin.pem ec2-user@{VIRTUOSO_EC2_INSTANCE_PUBLIC_IP}
```
Making sure to replace the EC2 IP address with that of your Virtuoso instance. You can find the public IP address of your Virtuoso instance in the EC2 Console or by viewing the Outputs of the Virtuoso Cloudformation stack you created in a previous step.

Once you have access to the Virtuoso instance, you can run the docker console by running the following command (this command assumes default values for names and ports was used):

```
> sudo docker exec -it vos /bin/bash
```

You can now view the generated `dba` password by running:

```
> less ../settings/dba_password
```

You can use the username `dba` and this password to login to the Virtuoso Conductor web page at `https://{VIRTUOSO_EC2_INSTANCE_PUBLIC_IP}:8890`

Note: In the above example `vos` is the name over the Docker container we want to connect. If you didn't use the default values you can get a list of running containers by executing:

```
> sudo docker ps
```

## Importing Ontologies and Vocabularies

### [Importing OWL Ontology](#import-owl)

Loading a small ontology is easy if a `.owl` file is available. Navigate to the Virtuoso Conductor and choose _Database -> Interactive SQL_. In the SQL console, you can load a `.owl` file by executing a command similar to:

```
SPARQL LOAD <http://purl.unep.org/sdg/sdgio.owl>;
```

### [Importing a Large OWL Ontology (Bulk Loading)](#import-large-owl)

Example for bulk loading an RDF file. This was used to load the CHEBI ontology:

[http://vos.openlinksw.com/owiki/wiki/VOS/VirtBulkRDFLoaderExampleSingle]

There is a copy of the rdfloader.sql script in this repository. You can use the existing script if you want. Just upload it to your Virtuoso instance and copy it to your docker container:

```
> scp -i keys/iode-admin.pem triple-store/rdfloader.sql ec2-user@{VIRTUOSO_HOST_IP}:~/
> ssh -i keys/iode-admin.pem ec2-user@{VIRTUOSO_HOST_IP}
> sudo docker cp rdfloader.sql vos:/opt/virtuoso-opensource/database/
```

This script was copied from:

[http://vos.openlinksw.com/owiki/wiki/VOS/VirtBulkRDFLoaderScript]

### [Importing SKOS Vocabulary](#import-skos-vocabulary)

Loading an RDF/XML SKOS vocabulary is easy once you've SSH'd into the Virtuoso instance. Secure copy the vocabulary to the Virtuoso instance:

SCP the vocab.xml file to the EC2 server
```
> scp -i keys/{your key} vocab.xml ec2-user@{host}:~/
```
copy the vocabulary file into the docker container.

```
> sudo docker cp vocab.xml vos:/opt/virtuoso-opensource/database/
```

Start a bash session in the Virtuoso docker container and start isql:

```
> sudo docker exec -it vos bash
> /opt/virtuoso-opensource/bin/isql 1111
```

You'll be prompted to enter the `dba` user password. Follow the instructions here for loading the vocabulary:

[http://docs.openlinksw.com/virtuoso/fn_rdf_load_rdfxml_mt/]

### Importing OceanBestPractices Ontologies and Vocabularies

There were 6 ontologies and vocabularies used during the development of this application:

  1. CHEBI (http://purl.obolibrary.org/obo/chebi.owl)
  2. ENVO (http://purl.obolibrary.org/obo/envo.owl)
  3. SDGIO (http://purl.unep.org/sdg/sdgio.owl)
  4. L05 (http://vocab.nerc.ac.uk/collection/L05/current/)
  5. L06 (http://vocab.nerc.ac.uk/collection/L06/current/)
  6. L22 (http://vocab.nerc.ac.uk/collection/L22/current/)

The application assumes that the graph names will match the the URLs for each ontology or vocabulary. For example, by default the application assumes that the ENVO ontology will imported as the graph name `http://purl.obolibrary.org/obo/envo.owl`.

#### CHEBI

Use section [Importing Large OWL Ontology](#large-owl-load) to load CHEBI. Because of the size of CHEBI it was only possible to import using the bulk loader instructions. You may want to create a snapshot of your instance prior to loading CHEBI. Please note that this import may take awhile.

There is a copy of the chebi.owl file used during the development of OceanBestPractices located at in the S3 bucket `obp-chebi-copy`. The goal is to get a copy of this file onto your Virtuoso instance. You can do this manually by:


1. Copy the file to your local machine with:

```
> aws s3 cp --recursive s3://obp-chebi-copy .
```

Then secure copy the file to your Virtuoso instance:

```
> scp -i keys/iode-admin.pem chebi.owl ec2-user@{VIRTUOSO_EC2_HOST}:~/
```

or

2. Copy the file directly to the Virtuoso instance with:

```
> ssh -i keys/iode-admin.pem ec2-user@{VIRTUOSO_EC2_HOST}
> aws s3 cp --recursive s3://obp-chebi-copy/chebi.owl .
```

If you receive the error "Unable to locate credentials" you should first run `> aws configure` to configure AWS credentials.

Once the CHEBI file is loaded onto Virtuoso you should copy the file to your docker and execute docker bash in order to procede with the ingest:

```
> sudo docker cp chebi.owl vos:/opt/virtuoso-opensource/database/
> sudo docker exec -it vos bash
```

Then follow the instructions in [Importing Large OWL Ontology](#large-owl-load).

#### ENVO and SDGIO

ENVO and SDGIO were reasonably sized Ontologies. You can use the instructions found in [Importing an OWL Ontology](#import-owl).

For example: after connecting to the Interactive SQL shell in the Virtuoso Conductor you can import ENVO by running the following SPARQL command:

```
SPARQL LOAD <http://purl.obolibrary.org/obo/envo.owl>;
```

#### SKOS Vocabularies

Each vocabulary can be ingested by following the instructions in [Importing SKOS Vocabulary](#import-skos-vocabulary)

For example, if I wanted to load the L05 vocabulary I would run the following commands:

```
> ssh -i keys/iode-admin.pem ec2-user@{VIRTUOSO_EC2_HOST}
> wget http://vocab.nerc.ac.uk/collection/L05/current/ -O L05.xml
> sudo docker cp L05.xml vos:/opt/virtuoso-opensource/database/
> sudo docker exec -it vos bash
> /opt/virtuoso-opensource/bin/isql 1111
SQL> DB.DBA.RDF_LOAD_RDFXML_MT (file_to_string_output('L05.xml'), '', 'http://vocab.nerc.ac.uk/collection/L05/current/');
SQL> quit;
> exit
> logout
```

**WARNING** Don't forget to run the percolator/create-tag-index.rb script, see README.md file!!!
